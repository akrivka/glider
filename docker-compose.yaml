services:
  # Main API + Frontend service
  glider-api:
    build:
      context: .
      dockerfile: glider-backend/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - SURREALDB_URL=ws://surrealdb:8000
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      - SURREALDB_NS=glider
      - SURREALDB_DB=glider
    command: ["python", "-m", "uvicorn", "glider.entrypoint_api:app", "--host", "0.0.0.0", "--port", "8000"]
    depends_on:
      temporal:
        condition: service_healthy
      surrealdb:
        condition: service_started

  # Temporal Worker service (same image, different entrypoint)
  glider-worker:
    build:
      context: .
      dockerfile: glider-backend/Dockerfile
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - SURREALDB_URL=ws://surrealdb:8000
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
    volumes:
      - ./glider-backend/secrets:/app/secrets
    command: ["python", "-m", "glider.entrypoint_worker"]
    depends_on:
      temporal:
        condition: service_healthy

  # Temporal Server
  temporal:
    image: temporalio/auto-setup:latest
    ports:
      - "7233:7233"
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=postgresql
    healthcheck:
      test: ["CMD", "temporal", "operator", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s
    depends_on:
      postgresql:
        condition: service_healthy

  # PostgreSQL for Temporal
  postgresql:
    image: postgres:16
    environment:
      - POSTGRES_USER=temporal
      - POSTGRES_PASSWORD=temporal
    volumes:
      - temporal_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U temporal"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Temporal UI
  temporal-ui:
    image: temporalio/ui:latest
    ports:
      - "8080:8080"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
    depends_on:
      temporal:
        condition: service_healthy

  # SurrealDB (using memory storage for development)
  surrealdb:
    image: surrealdb/surrealdb:latest
    ports:
      - "8001:8000"
    command: start --user root --pass root memory

  # Surrealist UI (SurrealDB's official UI)
  surrealist:
    image: surrealdb/surrealist:latest
    ports:
      - "8002:8080"
    depends_on:
      - surrealdb

  # SvelteKit Frontend (direct DB/Temporal access)
  glider-frontend2:
    build:
      context: ./glider-frontend2
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - SURREALDB_URL=ws://surrealdb:8000
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      - SURREALDB_NS=glider
      - SURREALDB_DB=glider
    depends_on:
      temporal:
        condition: service_healthy
      surrealdb:
        condition: service_started

volumes:
  temporal_postgres_data:
